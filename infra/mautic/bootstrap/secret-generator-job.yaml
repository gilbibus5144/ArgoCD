apiVersion: batch/v1
kind: Job
metadata:
  name: mysql-secret-generator
  namespace: emailsys
spec:
  backoffLimit: 2
  template:
    spec:
      serviceAccountName: secret-generator
      restartPolicy: OnFailure
      containers:
      - name: generator
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Generating random MySQL secrets..."

          MYSQL_ROOT_PASSWORD=$(openssl rand -hex 16)
          MYSQL_PASSWORD=$(openssl rand -hex 16)

          echo "Applying secret..."
          kubectl apply -f - <<-YAML
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: emailsys
type: Opaque
stringData:
  MYSQL_ROOT_PASSWORD: "$MYSQL_ROOT_PASSWORD"
  MYSQL_PASSWORD: "$MYSQL_PASSWORD"
YAML
