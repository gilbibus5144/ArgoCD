apiVersion: batch/v1
kind: Job
metadata:
  name: mysql-secret-generator
  namespace: emailsys
spec:
  backoffLimit: 1
  template:
    spec:
      serviceAccountName: secret-generator-sa
      restartPolicy: OnFailure
      containers:
      - name: generator
        image: alpine:3.18
        command:
          - /bin/sh
          - -c
          - |
            set -e
            TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
            CA_CERT=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            NS="emailsys"

            ROOTPW=$(openssl rand -base64 18)
            USERPW=$(openssl rand -base64 16)

            cat <<EOF > /tmp/secret.json
{
  "apiVersion":"v1",
  "kind":"Secret",
  "metadata":{"name":"mysql-secret","namespace":"emailsys"},
  "type":"Opaque",
  "stringData":{
    "MYSQL_ROOT_PASSWORD":"$ROOTPW",
    "MYSQL_PASSWORD":"$USERPW"
  }
}
EOF

            curl -k -X PUT \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              --data @/tmp/secret.json \
              https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}/api/v1/namespaces/emailsys/secrets/mysql-secret \
              --cacert $CA_CERT || exit 1

            echo "Secret mysql-secret created/updated."
